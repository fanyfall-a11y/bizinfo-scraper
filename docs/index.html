<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚˜í˜¼ìì°½ì—… - ê³µê³  ì„ íƒ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background: #f0f4ff; color: #222; }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    #login-screen {
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #0d2d6e, #1a4fa0);
      display: flex; align-items: center; justify-content: center; z-index: 100;
    }
    .login-box {
      background: white; border-radius: 20px; padding: 48px 40px;
      width: 360px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .login-box h1 { font-size: 22px; color: #1a4fa0; margin-bottom: 8px; }
    .login-box p { font-size: 14px; color: #888; margin-bottom: 28px; }
    .login-box input {
      width: 100%; padding: 14px 16px; border: 2px solid #dde4f5;
      border-radius: 10px; font-size: 16px; margin-bottom: 14px;
      outline: none; text-align: center; letter-spacing: 4px;
    }
    .login-box input:focus { border-color: #1a4fa0; }
    .login-btn {
      width: 100%; padding: 14px; background: #1a4fa0; color: white;
      border: none; border-radius: 10px; font-size: 16px; font-weight: 700;
      cursor: pointer; transition: background 0.2s;
    }
    .login-btn:hover { background: #0d2d6e; }
    .login-error { color: #e53e3e; font-size: 14px; margin-top: 10px; display: none; }

    /* ë©”ì¸ í™”ë©´ */
    #main-screen { display: none; }
    header {
      background: linear-gradient(90deg, #0d2d6e, #1a4fa0);
      padding: 16px 24px; color: white;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 50;
    }
    header h1 { font-size: 18px; font-weight: 800; }
    header span { font-size: 13px; opacity: 0.8; }

    .container { max-width: 860px; margin: 0 auto; padding: 16px 16px 100px; }

    /* ë‚ ì§œ íƒ­ */
    .date-tabs {
      background: white; border-radius: 14px; padding: 14px 16px;
      margin-bottom: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      overflow-x: auto;
    }
    .date-tabs-inner {
      display: flex; gap: 8px; min-width: max-content;
    }
    .date-tab {
      padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
      cursor: pointer; border: 2px solid #e0e8f8; color: #666; background: white;
      white-space: nowrap; transition: all 0.15s;
    }
    .date-tab:hover { border-color: #1a4fa0; color: #1a4fa0; }
    .date-tab.active { background: #1a4fa0; color: white; border-color: #1a4fa0; }
    .date-tab .tab-count { font-size: 11px; opacity: 0.8; margin-left: 4px; }

    /* í•„í„° ì˜ì—­ */
    .filter-section {
      background: white; border-radius: 14px; padding: 14px 16px;
      margin-bottom: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .filter-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
    .filter-row:last-child { margin-bottom: 0; }
    .filter-label { font-size: 12px; font-weight: 700; color: #888; min-width: 36px; }
    .filter-btn {
      padding: 5px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;
      cursor: pointer; border: 1.5px solid #dde4f5; color: #666; background: white;
      transition: all 0.15s; white-space: nowrap;
    }
    .filter-btn:hover { border-color: #1a4fa0; color: #1a4fa0; }
    .filter-btn.active { background: #1a4fa0; color: white; border-color: #1a4fa0; }

    /* í†µê³„ ë°” */
    .info-bar {
      background: white; border-radius: 12px; padding: 12px 16px;
      margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .info-bar .date-str { font-size: 14px; color: #555; }
    .info-bar .count { font-size: 14px; font-weight: 700; color: #1a4fa0; }

    .empty-msg {
      text-align: center; padding: 60px 20px; color: #888;
      background: white; border-radius: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .empty-msg p { font-size: 18px; margin-bottom: 8px; }
    .empty-msg small { font-size: 14px; }

    /* ê³µê³  ì¹´ë“œ */
    .item-card {
      background: white; border-radius: 14px; padding: 16px 18px;
      margin-bottom: 10px; display: flex; align-items: flex-start; gap: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06); cursor: pointer;
      border: 2px solid transparent; transition: border-color 0.15s, box-shadow 0.15s;
    }
    .item-card:hover { border-color: #a0b8f0; }
    .item-card.selected { border-color: #1a4fa0; background: #f0f5ff; }
    .item-card.target { border-left: 4px solid #f0a500; }
    .item-card.target.selected { border-color: #1a4fa0; background: #f0f5ff; border-left: 4px solid #1a4fa0; }

    .item-card input[type=checkbox] {
      width: 18px; height: 18px; margin-top: 3px; flex-shrink: 0;
      accent-color: #1a4fa0; cursor: pointer;
    }
    .item-info { flex: 1; min-width: 0; }
    .item-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 6px; }

    .badge {
      display: inline-block; font-size: 11px; font-weight: 700;
      padding: 2px 8px; border-radius: 12px;
    }
    .badge-target { background: #fff3cd; color: #b87900; border: 1px solid #f0a500; }
    .badge-region-tag { background: #1a4fa0; color: white; }
    .badge-category { background: #f0f4ff; color: #1a4fa0; border: 1px solid #c0d0f0; }
    .badge-region { background: #f0fff4; color: #276749; border: 1px solid #9ae6b4; }

    .item-title { font-size: 14px; font-weight: 600; line-height: 1.5; color: #1a2a4a; }
    .item-date { font-size: 12px; color: #999; margin-top: 4px; }

    /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ */
    .bottom-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: white; border-top: 1px solid #e0e8f8;
      padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.08); z-index: 50;
    }
    .selected-count { font-size: 14px; color: #555; }
    .selected-count strong { color: #1a4fa0; font-size: 18px; }
    .generate-btn {
      padding: 12px 24px; background: #1a4fa0; color: white;
      border: none; border-radius: 12px; font-size: 15px; font-weight: 700;
      cursor: pointer; transition: background 0.2s; opacity: 0.4; pointer-events: none;
    }
    .generate-btn.active { opacity: 1; pointer-events: auto; }
    .generate-btn.active:hover { background: #0d2d6e; }

    /* ëª¨ë‹¬ */
    #modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center; z-index: 200;
    }
    #modal.show { display: flex; }
    .modal-box {
      background: white; border-radius: 20px; padding: 36px;
      text-align: center; width: 320px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-box .icon { font-size: 44px; margin-bottom: 14px; }
    .modal-box h2 { font-size: 18px; margin-bottom: 10px; color: #1a2a4a; }
    .modal-box p { font-size: 13px; color: #666; line-height: 1.6; white-space: pre-line; }
    .modal-close {
      margin-top: 20px; padding: 10px 24px; background: #1a4fa0; color: white;
      border: none; border-radius: 10px; font-size: 14px; cursor: pointer; display: none;
    }

    /* ìŠ¤í¬ë¡¤ë°” */
    .date-tabs::-webkit-scrollbar { height: 4px; }
    .date-tabs::-webkit-scrollbar-thumb { background: #c0d0f0; border-radius: 4px; }
  </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ í™”ë©´ -->
<div id="login-screen">
  <div class="login-box">
    <h1>ğŸ”· ë‚˜í˜¼ìì°½ì—…</h1>
    <p>ê³µê³  ì„ íƒ ì‹œìŠ¤í…œ</p>
    <input type="password" id="pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')login()">
    <button class="login-btn" onclick="login()">ë¡œê·¸ì¸</button>
    <div class="login-error" id="login-error">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
  </div>
</div>

<!-- ë©”ì¸ í™”ë©´ -->
<div id="main-screen">
  <header>
    <h1>ğŸ”· ë‚˜í˜¼ìì°½ì—… ê³µê³  ì„ íƒ</h1>
    <span id="header-date"></span>
  </header>

  <div class="container">

    <!-- ë‚ ì§œ íƒ­ -->
    <div class="date-tabs">
      <div class="date-tabs-inner" id="date-tabs-inner"></div>
    </div>

    <!-- í•„í„° -->
    <div class="filter-section">
      <div class="filter-row">
        <span class="filter-label">ë¶„ì•¼</span>
        <div id="category-filters"></div>
      </div>
      <div class="filter-row">
        <span class="filter-label">ì§€ì—­</span>
        <div id="region-filters"></div>
      </div>
      <div class="filter-row">
        <span class="filter-label">ëŒ€ìƒ</span>
        <button class="filter-btn active" id="filter-all" onclick="setTargetFilter('all')">ì „ì²´</button>
        <button class="filter-btn" id="filter-target" onclick="setTargetFilter('target')">â­ ì¶”ì²œë§Œ</button>
      </div>
    </div>

    <!-- í†µê³„ -->
    <div class="info-bar">
      <span class="date-str" id="today-date"></span>
      <span class="count" id="item-count"></span>
    </div>

    <!-- ê³µê³  ëª©ë¡ -->
    <div id="item-list"></div>
  </div>

  <div class="bottom-bar">
    <span class="selected-count"><strong id="sel-count">0</strong>ê°œ ì„ íƒë¨</span>
    <button class="generate-btn" id="gen-btn" onclick="startGenerate()">ğŸš€ ì½˜í…ì¸  ìƒì„±</button>
  </div>
</div>

<!-- ëª¨ë‹¬ -->
<div id="modal">
  <div class="modal-box">
    <div class="icon" id="modal-icon">â³</div>
    <h2 id="modal-title">GitHub Actions ì‹¤í–‰ ì¤‘...</h2>
    <p id="modal-desc">ì„ íƒí•œ ê³µê³ ì˜ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”.\nì™„ë£Œë˜ë©´ ì´ë©”ì¼ë¡œ ì•Œë ¤ë“œë ¤ìš”!</p>
    <button class="modal-close" id="modal-close-btn" onclick="closeModal()">í™•ì¸</button>
  </div>
</div>

<script>
  const PASSWORD = 'bizinfo2026';
  const GITHUB_OWNER = 'fanyfall-a11y';
  const GITHUB_REPO = 'bizinfo-scraper';

  const CATEGORIES = ['ì „ì²´', 'ì‚¬ì—…í™”', 'ì°½ì—…êµìœ¡', 'ì»¨ì„¤íŒ…/ë©˜í† ë§', 'ê¸€ë¡œë²Œ', 'ì‹œì„¤ì œê³µ', 'ìê¸ˆì§€ì›', 'íŒë¡œ/ë§ˆì¼€íŒ…'];
  const REGIONS = ['ì „ì²´', 'ì „êµ­', 'ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ëŒ€ì „', 'ê´‘ì£¼', 'ìš¸ì‚°', 'ì„¸ì¢…', 'ê°•ì›', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ì œì£¼'];

  let allData = {};      // { 'YYYY-MM-DD': { date, total, targetCount, items } }
  let currentDate = '';  // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ
  let currentItems = []; // í˜„ì¬ ë‚ ì§œì˜ ì „ì²´ ì•„ì´í…œ
  let filteredItems = []; // í•„í„° ì ìš©ëœ ì•„ì´í…œ
  let selected = new Set();

  let activeCategory = 'ì „ì²´';
  let activeRegion = 'ì „ì²´';
  let activeTarget = 'all';

  function login() {
    const pw = document.getElementById('pw-input').value;
    if (pw === PASSWORD) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-screen').style.display = 'block';
      loadAllData();
    } else {
      document.getElementById('login-error').style.display = 'block';
    }
  }

  async function loadAllData() {
    // ì˜¤ëŠ˜ë¶€í„° 7ì¼ ì „ê¹Œì§€ íŒŒì¼ ë¡œë“œ ì‹œë„
    const dates = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      dates.push(d.toISOString().slice(0, 10));
    }

    const fetches = dates.map(async date => {
      try {
        const res = await fetch(`daily/${date}.json?t=${Date.now()}`);
        if (res.ok) {
          const data = await res.json();
          return { date, data };
        }
      } catch {}
      return null;
    });

    const results = await Promise.all(fetches);
    results.forEach(r => {
      if (r) allData[r.date] = r.data;
    });

    // ë‚ ì§œ íƒ­ ë Œë”ë§
    renderDateTabs(dates);

    // í•„í„° ë²„íŠ¼ ë Œë”ë§
    renderFilters();

    // ê°€ì¥ ìµœê·¼ ë‚ ì§œ ì„ íƒ
    const availableDates = dates.filter(d => allData[d]);
    if (availableDates.length > 0) {
      selectDate(availableDates[0]);
    } else {
      // ë°ì´í„° ì—†ìœ¼ë©´ today-list.json ì‹œë„ (í´ë°±)
      try {
        const res = await fetch(`today-list.json?t=${Date.now()}`);
        if (res.ok) {
          const data = await res.json();
          allData[data.date] = data;
          renderDateTabs([data.date]);
          selectDate(data.date);
        }
      } catch {}
      document.getElementById('item-list').innerHTML = `<div class="empty-msg"><p>ğŸ˜´ ìˆ˜ì§‘ëœ ê³µê³ ê°€ ì—†ì–´ìš”</p><small>ìƒˆë²½ ìˆ˜ì§‘ í›„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”</small></div>`;
    }

    // í—¤ë” ë‚ ì§œ
    document.getElementById('header-date').textContent = new Date().toLocaleDateString('ko-KR');
  }

  function renderDateTabs(dates) {
    const container = document.getElementById('date-tabs-inner');
    container.innerHTML = dates.map(date => {
      const data = allData[date];
      if (!data) return `<button class="date-tab" onclick="selectDate('${date}')" id="tab-${date}" disabled style="opacity:0.3">${formatDate(date)}</button>`;
      return `<button class="date-tab" onclick="selectDate('${date}')" id="tab-${date}">
        ${formatDate(date)}
        <span class="tab-count">${data.total || data.items?.length || 0}ê±´</span>
      </button>`;
    }).join('');
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return `${d.getMonth()+1}/${d.getDate()}`;
  }

  function renderFilters() {
    // ë¶„ì•¼ í•„í„°
    const catDiv = document.getElementById('category-filters');
    catDiv.style.display = 'flex';
    catDiv.style.flexWrap = 'wrap';
    catDiv.style.gap = '6px';
    catDiv.innerHTML = CATEGORIES.map(cat =>
      `<button class="filter-btn ${cat === 'ì „ì²´' ? 'active' : ''}" id="cat-${cat}" onclick="setCategoryFilter('${cat}')">${cat}</button>`
    ).join('');

    // ì§€ì—­ í•„í„°
    const regDiv = document.getElementById('region-filters');
    regDiv.style.display = 'flex';
    regDiv.style.flexWrap = 'wrap';
    regDiv.style.gap = '6px';
    regDiv.innerHTML = REGIONS.map(reg =>
      `<button class="filter-btn ${reg === 'ì „ì²´' ? 'active' : ''}" id="reg-${reg}" onclick="setRegionFilter('${reg}')">${reg}</button>`
    ).join('');
  }

  function selectDate(date) {
    currentDate = date;
    currentItems = allData[date]?.items || [];
    selected.clear();
    updateBtn();

    // íƒ­ í™œì„±í™”
    document.querySelectorAll('.date-tab').forEach(t => t.classList.remove('active'));
    const tab = document.getElementById(`tab-${date}`);
    if (tab) tab.classList.add('active');

    // ë‚ ì§œ í‘œì‹œ
    document.getElementById('today-date').textContent = `ğŸ“… ${date} ìˆ˜ì§‘ (ì´ ${currentItems.length}ê±´)`;

    applyFilters();
  }

  function setCategoryFilter(cat) {
    activeCategory = cat;
    document.querySelectorAll('[id^="cat-"]').forEach(b => b.classList.remove('active'));
    document.getElementById(`cat-${cat}`)?.classList.add('active');
    applyFilters();
  }

  function setRegionFilter(reg) {
    activeRegion = reg;
    document.querySelectorAll('[id^="reg-"]').forEach(b => b.classList.remove('active'));
    document.getElementById(`reg-${reg}`)?.classList.add('active');
    applyFilters();
  }

  function setTargetFilter(type) {
    activeTarget = type;
    document.getElementById('filter-all').classList.toggle('active', type === 'all');
    document.getElementById('filter-target').classList.toggle('active', type === 'target');
    applyFilters();
  }

  function applyFilters() {
    filteredItems = currentItems.filter(item => {
      if (activeCategory !== 'ì „ì²´' && item.category !== activeCategory) return false;
      if (activeRegion !== 'ì „ì²´' && item.regionCategory !== activeRegion) return false;
      if (activeTarget === 'target' && !item.isTarget) return false;
      return true;
    });

    // íƒ€ê²Ÿ ê³µê³  ë¨¼ì € ì •ë ¬
    filteredItems.sort((a, b) => (b.isTarget ? 1 : 0) - (a.isTarget ? 1 : 0));

    document.getElementById('item-count').textContent = `${filteredItems.length}ê±´ í‘œì‹œ`;
    renderList();
  }

  function renderList() {
    const list = document.getElementById('item-list');

    if (filteredItems.length === 0) {
      list.innerHTML = `<div class="empty-msg"><p>ğŸ” í•´ë‹¹ ì¡°ê±´ì˜ ê³µê³ ê°€ ì—†ì–´ìš”</p><small>í•„í„°ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”</small></div>`;
      return;
    }

    list.innerHTML = filteredItems.map(item => `
      <div class="item-card ${item.isTarget ? 'target' : ''} ${selected.has(item.idx) ? 'selected' : ''}"
           id="card-${item.idx}" onclick="toggleSelect(${item.idx})">
        <input type="checkbox" id="chk-${item.idx}" ${selected.has(item.idx) ? 'checked' : ''}
               onclick="event.stopPropagation(); toggleSelect(${item.idx})">
        <div class="item-info">
          <div class="item-badges">
            ${item.isTarget ? '<span class="badge badge-target">â­ ì¶”ì²œ</span>' : ''}
            ${item.region && item.region !== 'ì „êµ­' ? `<span class="badge badge-region-tag">${item.region}</span>` : ''}
            <span class="badge badge-category">${item.category || 'ì‚¬ì—…í™”'}</span>
            <span class="badge badge-region">${item.regionCategory || 'ì „êµ­'}</span>
          </div>
          <div class="item-title">${item.cleanTitle || item.title}</div>
          <div class="item-date">ğŸ“… ë§ˆê° ${item.date}</div>
        </div>
      </div>
    `).join('');
  }

  function toggleSelect(idx) {
    if (selected.has(idx)) {
      selected.delete(idx);
    } else {
      if (selected.size >= 3) {
        alert('ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•´ìš”!');
        return;
      }
      selected.add(idx);
    }
    // ì¹´ë“œ ìƒíƒœ ì—…ë°ì´íŠ¸
    const card = document.getElementById(`card-${idx}`);
    const chk = document.getElementById(`chk-${idx}`);
    if (card) card.classList.toggle('selected', selected.has(idx));
    if (chk) chk.checked = selected.has(idx);
    updateBtn();
  }

  function updateBtn() {
    const cnt = selected.size;
    document.getElementById('sel-count').textContent = cnt;
    document.getElementById('gen-btn').classList.toggle('active', cnt > 0);
  }

  async function startGenerate() {
    if (selected.size === 0) return;

    const selectedItems = currentItems.filter(item => selected.has(item.idx));
    const urls = selectedItems.map(item => item.url).join(',');

    const token = prompt('GitHub Personal Access Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(Settings â†’ Developer settings â†’ Personal access tokens)');
    if (!token) return;

    showModal('â³', 'GitHub Actions ì‹¤í–‰ ì¤‘...', 'ì„ íƒí•œ ê³µê³ ì˜ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”.\nì™„ë£Œë˜ë©´ ì´ë©”ì¼ë¡œ ì•Œë ¤ë“œë ¤ìš”!');

    try {
      const res = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/actions/workflows/generate.yml/dispatches`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/vnd.github+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ref: 'main',
          inputs: { target_urls: urls }
        })
      });

      if (res.ok || res.status === 204) {
        showModal('âœ…', 'ìƒì„± ìš”ì²­ ì™„ë£Œ!', `${selectedItems.length}ê±´ì˜ ì½˜í…ì¸  ìƒì„±ì´ ì‹œì‘ëì–´ìš”.\n5~10ë¶„ í›„ ì´ë©”ì¼ë¡œ ë“œë¼ì´ë¸Œ ë§í¬ê°€ ì „ì†¡ë©ë‹ˆë‹¤.`, true);
      } else {
        const err = await res.json();
        showModal('âŒ', 'ì˜¤ë¥˜ ë°œìƒ', `GitHub API ì˜¤ë¥˜: ${err.message}`, true);
      }
    } catch (e) {
      showModal('âŒ', 'ì˜¤ë¥˜ ë°œìƒ', e.message, true);
    }
  }

  function showModal(icon, title, desc, showClose = false) {
    document.getElementById('modal-icon').textContent = icon;
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-desc').textContent = desc;
    document.getElementById('modal-close-btn').style.display = showClose ? 'inline-block' : 'none';
    document.getElementById('modal').classList.add('show');
  }

  function closeModal() {
    document.getElementById('modal').classList.remove('show');
  }
</script>
</body>
</html>
