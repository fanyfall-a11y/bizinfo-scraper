<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚˜í˜¼ìì°½ì—… - ê³µê³  ì„ íƒ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background: #f0f4ff; color: #222; }

    /* â”€â”€ ë¡œê·¸ì¸ â”€â”€ */
    #login-screen {
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #0d2d6e, #1a4fa0);
      display: flex; align-items: center; justify-content: center; z-index: 999;
    }
    .login-box {
      background: white; border-radius: 20px; padding: 48px 40px;
      width: 360px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .login-box h1 { font-size: 22px; color: #1a4fa0; margin-bottom: 8px; }
    .login-box p { font-size: 14px; color: #888; margin-bottom: 28px; }
    .login-box input {
      width: 100%; padding: 14px 16px; border: 2px solid #dde4f5;
      border-radius: 10px; font-size: 16px; margin-bottom: 14px;
      outline: none; text-align: center; letter-spacing: 4px;
    }
    .login-box input:focus { border-color: #1a4fa0; }
    .login-btn {
      width: 100%; padding: 14px; background: #1a4fa0; color: white;
      border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer;
    }
    .login-btn:hover { background: #0d2d6e; }
    .login-error { color: #e53e3e; font-size: 14px; margin-top: 10px; display: none; }

    /* â”€â”€ ë©”ì¸ â”€â”€ */
    #main-screen { display: none; min-height: 100vh; }

    header {
      background: linear-gradient(90deg, #0d2d6e, #1a4fa0);
      padding: 14px 20px; color: white;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 100;
    }
    header h1 { font-size: 17px; font-weight: 800; }
    .header-right { font-size: 13px; opacity: 0.85; }

    .layout { display: flex; gap: 0; min-height: calc(100vh - 50px); }

    /* â”€â”€ ì™¼ìª½: ê³µê³  ëª©ë¡ â”€â”€ */
    .list-panel { flex: 1; min-width: 0; padding: 16px 16px 120px; }

    /* ë‚ ì§œ íƒ­ */
    .date-tabs {
      background: white; border-radius: 12px; padding: 12px 14px;
      margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      overflow-x: auto; white-space: nowrap;
    }
    .date-tabs::-webkit-scrollbar { height: 3px; }
    .date-tabs::-webkit-scrollbar-thumb { background: #c0d0f0; border-radius: 3px; }
    .date-tab {
      display: inline-block; padding: 7px 14px; border-radius: 18px;
      font-size: 13px; font-weight: 600; cursor: pointer;
      border: 2px solid #e0e8f8; color: #666; background: white;
      margin-right: 6px; transition: all 0.15s;
    }
    .date-tab:hover { border-color: #1a4fa0; color: #1a4fa0; }
    .date-tab.active { background: #1a4fa0; color: white; border-color: #1a4fa0; }
    .date-tab .tab-cnt { font-size: 11px; opacity: 0.8; margin-left: 3px; }
    .date-tab.no-data { opacity: 0.35; cursor: default; }

    /* ì¶œì²˜ íƒ­ */
    .source-tabs {
      background: white; border-radius: 12px; padding: 10px 14px;
      margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .source-tab {
      padding: 7px 14px; border-radius: 18px; font-size: 13px; font-weight: 700;
      cursor: pointer; border: 2px solid #e0e8f8; color: #666; background: white;
      transition: all 0.15s; display: flex; align-items: center; gap: 5px;
    }
    .source-tab:hover { border-color: var(--color); color: var(--color); }
    .source-tab.active { background: var(--color); color: white; border-color: var(--color); }
    .source-tab .src-cnt { font-size: 11px; opacity: 0.85; }

    /* í•„í„° */
    .filter-wrap {
      background: white; border-radius: 12px; padding: 12px 14px;
      margin-bottom: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.07);
    }
    .filter-row { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
    .filter-row:last-child { margin-bottom: 0; }
    .filter-label { font-size: 11px; font-weight: 700; color: #999; min-width: 30px; }
    .filter-chip {
      padding: 4px 10px; border-radius: 14px; font-size: 12px; font-weight: 600;
      cursor: pointer; border: 1.5px solid #e0e8f8; color: #666; background: white;
      transition: all 0.15s;
    }
    .filter-chip:hover { border-color: #1a4fa0; color: #1a4fa0; }
    .filter-chip.active { background: #1a4fa0; color: white; border-color: #1a4fa0; }

    /* ëª©ë¡ í†µê³„ */
    .list-stat {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 4px; margin-bottom: 8px;
    }
    .list-stat span { font-size: 13px; color: #666; }
    .list-stat strong { color: #1a4fa0; }

    /* ê³µê³  ì¹´ë“œ */
    .item-card {
      background: white; border-radius: 14px; padding: 14px 16px;
      margin-bottom: 9px; display: flex; align-items: flex-start; gap: 11px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06); cursor: pointer;
      border: 2px solid transparent; transition: all 0.15s;
    }
    .item-card:hover { border-color: #a0b8f0; transform: translateY(-1px); }
    .item-card.selected { border-color: #1a4fa0; background: #f0f5ff; }
    .item-card.is-target { border-left: 4px solid #f0a500; }
    .item-card.is-target.selected { border-color: #1a4fa0; border-left: 4px solid #1a4fa0; background: #f0f5ff; }

    .item-card input[type=checkbox] {
      width: 18px; height: 18px; margin-top: 2px; flex-shrink: 0;
      accent-color: #1a4fa0; cursor: pointer;
    }
    .item-body { flex: 1; min-width: 0; }

    .badge-row { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px; }
    .badge {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 10px;
    }
    .badge-target  { background: #fff8e1; color: #c17900; border: 1px solid #ffd54f; }
    .badge-cat     { background: #e8f4fd; color: #1565c0; border: 1px solid #90caf9; }
    .badge-region  { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    .badge-source  { background: #f3e5f5; color: #7b1fa2; border: 1px solid #ce93d8; }

    .item-title { font-size: 14px; font-weight: 600; line-height: 1.5; color: #1a2a4a; margin-bottom: 4px; }
    .item-meta  { font-size: 12px; color: #aaa; }

    .empty-msg {
      text-align: center; padding: 50px 20px; color: #888;
      background: white; border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .empty-msg p { font-size: 17px; margin-bottom: 6px; }

    /* â”€â”€ ì˜¤ë¥¸ìª½: ì¥ë°”êµ¬ë‹ˆ â”€â”€ */
    .cart-panel {
      width: 300px; flex-shrink: 0;
      background: white; border-left: 1px solid #e0e8f8;
      display: flex; flex-direction: column;
      position: sticky; top: 50px; height: calc(100vh - 50px);
      overflow: hidden;
    }
    .cart-header {
      padding: 16px 18px; border-bottom: 1px solid #e0e8f8;
      display: flex; align-items: center; justify-content: space-between;
    }
    .cart-header h2 { font-size: 15px; font-weight: 800; color: #1a2a4a; }
    .cart-count-badge {
      background: #1a4fa0; color: white; font-size: 12px; font-weight: 700;
      padding: 2px 9px; border-radius: 12px;
    }
    .cart-body { flex: 1; overflow-y: auto; padding: 12px 14px; }
    .cart-body::-webkit-scrollbar { width: 4px; }
    .cart-body::-webkit-scrollbar-thumb { background: #c0d0f0; border-radius: 4px; }

    .cart-empty {
      text-align: center; padding: 40px 10px; color: #bbb;
    }
    .cart-empty p { font-size: 14px; margin-top: 10px; line-height: 1.6; }

    .cart-item {
      background: #f8faff; border: 1.5px solid #e0e8f8; border-radius: 12px;
      padding: 11px 12px; margin-bottom: 8px; position: relative;
    }
    .cart-item .cart-item-badges { display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 5px; }
    .cart-item-title { font-size: 13px; font-weight: 600; color: #1a2a4a; line-height: 1.4; padding-right: 22px; }
    .cart-item-source { font-size: 11px; color: #999; margin-top: 4px; }
    .cart-remove {
      position: absolute; top: 8px; right: 8px;
      width: 20px; height: 20px; border-radius: 50%;
      background: #eee; border: none; cursor: pointer;
      font-size: 12px; color: #666; display: flex; align-items: center; justify-content: center;
      transition: background 0.15s;
    }
    .cart-remove:hover { background: #ffdddd; color: #e53e3e; }

    .cart-footer { padding: 14px; border-top: 1px solid #e0e8f8; }
    .cart-limit { font-size: 12px; color: #aaa; text-align: center; margin-bottom: 10px; }
    .generate-btn {
      width: 100%; padding: 14px; border: none; border-radius: 12px;
      font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      background: #e0e8f8; color: #999;
    }
    .generate-btn.active { background: #1a4fa0; color: white; }
    .generate-btn.active:hover { background: #0d2d6e; }

    /* â”€â”€ ëª¨ë‹¬ â”€â”€ */
    #modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center; z-index: 500;
    }
    #modal.show { display: flex; }
    .modal-box {
      background: white; border-radius: 20px; padding: 36px;
      text-align: center; width: 320px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-icon { font-size: 44px; margin-bottom: 12px; }
    .modal-box h2 { font-size: 18px; margin-bottom: 10px; color: #1a2a4a; }
    .modal-box p { font-size: 13px; color: #666; line-height: 1.7; white-space: pre-line; }
    .modal-close {
      margin-top: 20px; padding: 10px 28px; background: #1a4fa0; color: white;
      border: none; border-radius: 10px; font-size: 14px; cursor: pointer; display: none;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 700px) {
      .cart-panel { display: none; }
      .list-panel { padding-bottom: 160px; }
    }
  </style>
</head>
<body>

<!-- ë¡œê·¸ì¸ -->
<div id="login-screen">
  <div class="login-box">
    <h1>ğŸ”· ë‚˜í˜¼ìì°½ì—…</h1>
    <p>ì§€ì›ì‚¬ì—… ê³µê³  ì„ íƒ ì‹œìŠ¤í…œ</p>
    <input type="password" id="pw-input" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')login()">
    <button class="login-btn" onclick="login()">ë¡œê·¸ì¸</button>
    <div class="login-error" id="login-error">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</div>
  </div>
</div>

<!-- ë©”ì¸ -->
<div id="main-screen">
  <header>
    <h1>ğŸ”· ë‚˜í˜¼ìì°½ì—… ê³µê³  ì„ íƒ</h1>
    <div class="header-right" id="header-date"></div>
  </header>

  <div class="layout">
    <!-- ì™¼ìª½: ëª©ë¡ -->
    <div class="list-panel">

      <!-- ë‚ ì§œ íƒ­ -->
      <div class="date-tabs" id="date-tabs"></div>

      <!-- ì¶œì²˜ íƒ­ -->
      <div class="source-tabs" id="source-tabs"></div>

      <!-- í•„í„° -->
      <div class="filter-wrap">
        <div class="filter-row">
          <span class="filter-label">ë¶„ì•¼</span>
          <div id="cat-filters" style="display:flex;flex-wrap:wrap;gap:5px;"></div>
        </div>
        <div class="filter-row">
          <span class="filter-label">ì§€ì—­</span>
          <div id="reg-filters" style="display:flex;flex-wrap:wrap;gap:5px;"></div>
        </div>
        <div class="filter-row">
          <span class="filter-label">ëŒ€ìƒ</span>
          <button class="filter-chip active" id="f-all" onclick="setTargetFilter('all')">ì „ì²´</button>
          <button class="filter-chip" id="f-target" onclick="setTargetFilter('target')">â­ ì¶”ì²œë§Œ</button>
        </div>
      </div>

      <!-- í†µê³„ -->
      <div class="list-stat">
        <span id="list-stat-text">ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
      </div>

      <!-- ê³µê³  ëª©ë¡ -->
      <div id="item-list"></div>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì¥ë°”êµ¬ë‹ˆ -->
    <div class="cart-panel">
      <div class="cart-header">
        <h2>ğŸ›’ ì„ íƒí•œ ê³µê³ </h2>
        <span class="cart-count-badge" id="cart-count">0</span>
      </div>
      <div class="cart-body" id="cart-body">
        <div class="cart-empty">
          <div style="font-size:36px;">ğŸ“‹</div>
          <p>ê³µê³ ë¥¼ ì„ íƒí•˜ë©´<br>ì—¬ê¸°ì— ë‹´ê²¨ìš”</p>
        </div>
      </div>
      <div class="cart-footer">
        <div class="cart-limit" id="cart-limit">ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥</div>
        <button class="generate-btn" id="gen-btn" onclick="startGenerate()">ğŸš€ ì½˜í…ì¸  ìƒì„±</button>
      </div>
    </div>
  </div>
</div>

<!-- ëª¨ë‹¬ -->
<div id="modal">
  <div class="modal-box">
    <div class="modal-icon" id="modal-icon">â³</div>
    <h2 id="modal-title">ì‹¤í–‰ ì¤‘...</h2>
    <p id="modal-desc"></p>
    <button class="modal-close" id="modal-close-btn" onclick="closeModal()">í™•ì¸</button>
  </div>
</div>

<script>
const PASSWORD = 'bizinfo2026';
const GITHUB_OWNER = 'fanyfall-a11y';
const GITHUB_REPO = 'bizinfo-scraper';

const SOURCE_INFO = {
  bizinfo:  { name: 'ê¸°ì—…ë§ˆë‹¹',    icon: 'ğŸ¢', color: '#1a4fa0' },
  kstartup: { name: 'K-Startup',  icon: 'ğŸš€', color: '#e8360e' },
  sbiz:     { name: 'ì†Œìƒê³µì¸ë§ˆë‹¹', icon: 'ğŸª', color: '#2ecc71' },
  smtech:   { name: 'ì¤‘ì†Œê¸°ì—…ê¸°ìˆ ', icon: 'ğŸ”¬', color: '#9b59b6' },
};

const CATEGORIES = ['ì „ì²´', 'ì‚¬ì—…í™”', 'ì°½ì—…êµìœ¡', 'ì»¨ì„¤íŒ…/ë©˜í† ë§', 'ê¸€ë¡œë²Œ', 'ì‹œì„¤ì œê³µ', 'ìê¸ˆì§€ì›', 'íŒë¡œ/ë§ˆì¼€íŒ…'];
const REGIONS    = ['ì „ì²´', 'ì „êµ­', 'ì„œìš¸', 'ê²½ê¸°', 'ì¸ì²œ', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ëŒ€ì „', 'ê´‘ì£¼', 'ìš¸ì‚°', 'ì„¸ì¢…', 'ê°•ì›', 'ì¶©ë¶', 'ì¶©ë‚¨', 'ì „ë¶', 'ì „ë‚¨', 'ê²½ë¶', 'ê²½ë‚¨', 'ì œì£¼'];

// ìƒíƒœ
let allData = {};         // { 'YYYY-MM-DD': { date, sources: { bizinfo: {items}, ... } } }
let currentDate  = '';
let currentSource = 'all';  // í˜„ì¬ ì„ íƒëœ ì¶œì²˜
let activeCategory = 'ì „ì²´';
let activeRegion   = 'ì „êµ­';  // ê¸°ë³¸ê°’ ì „êµ­ìœ¼ë¡œ ì‹œì‘
let activeTarget   = 'all';

let cart = [];        // { id, source, cleanTitle, url, category, regionCategory, isTarget }
let itemMap = {};     // id â†’ item ì „ì²´ ê°ì²´ (ë¹ ë¥¸ ì¡°íšŒìš©)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë¡œê·¸ì¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function login() {
  if (document.getElementById('pw-input').value === PASSWORD) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('main-screen').style.display = 'block';
    init();
  } else {
    document.getElementById('login-error').style.display = 'block';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  document.getElementById('header-date').textContent = new Date().toLocaleDateString('ko-KR');
  renderFilters();
  await loadAllData();
}

async function loadAllData() {
  const dates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    dates.push(d.toISOString().slice(0, 10));
  }

  // daily/ í´ë”ì—ì„œ ë‚ ì§œë³„ íŒŒì¼ ë¡œë“œ ì‹œë„
  const results = await Promise.all(dates.map(async date => {
    try {
      const res = await fetch(`daily/${date}.json?t=${Date.now()}`);
      if (res.ok) {
        const data = await res.json();
        // sources êµ¬ì¡°ê°€ ì—†ìœ¼ë©´ today-list.json êµ¬ë²„ì „ í¬ë§· ë³€í™˜
        if (!data.sources && data.items) {
          data.sources = { bizinfo: { id:'bizinfo', name:'ê¸°ì—…ë§ˆë‹¹', icon:'ğŸ¢', color:'#1a4fa0', count: data.items.length, targetCount: data.targetCount||0, items: data.items } };
        }
        return { date, data };
      }
    } catch {}
    return null;
  }));

  results.forEach(r => { if (r) allData[r.date] = r.data; });

  // daily/ ì— ì—†ìœ¼ë©´ today-list.json í´ë°±
  if (Object.keys(allData).length === 0) {
    try {
      const res = await fetch(`today-list.json?t=${Date.now()}`);
      if (res.ok) {
        const data = await res.json();
        if (data && data.date) {
          if (!data.sources && data.items) {
            data.sources = { bizinfo: { id:'bizinfo', name:'ê¸°ì—…ë§ˆë‹¹', icon:'ğŸ¢', color:'#1a4fa0', count: data.items.length, targetCount: data.targetCount||0, items: data.items } };
          }
          allData[data.date] = data;
        }
      }
    } catch {}
  }

  renderDateTabs(dates);

  const available = dates.filter(d => allData[d]);
  if (available.length > 0) {
    selectDate(available[0]);
  } else {
    document.getElementById('item-list').innerHTML =
      `<div class="empty-msg"><p>ğŸ˜´ ìˆ˜ì§‘ëœ ê³µê³ ê°€ ì—†ì–´ìš”</p><small>ìƒˆë²½ ìˆ˜ì§‘ í›„ í™•ì¸í•´ì£¼ì„¸ìš”</small></div>`;
    document.getElementById('list-stat-text').textContent = 'ë°ì´í„° ì—†ìŒ';
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ë‚ ì§œ íƒ­
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDateTabs(dates) {
  const container = document.getElementById('date-tabs');
  container.innerHTML = dates.map(date => {
    const data = allData[date];
    const cnt  = data ? (data.total || 0) : 0;
    const noData = !data;
    const d = new Date(date);
    const label = `${d.getMonth()+1}/${d.getDate()}`;
    return `<button class="date-tab${noData?' no-data':''}" id="dtab-${date}"
      onclick="${noData?'':` selectDate('${date}')`}">${label}${!noData?`<span class="tab-cnt">${cnt}</span>`:''}</button>`;
  }).join('');
}

function selectDate(date) {
  currentDate  = date;
  currentSource = 'all';

  document.querySelectorAll('.date-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`dtab-${date}`)?.classList.add('active');

  renderSourceTabs();
  applyFilters();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì¶œì²˜ íƒ­
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSourceTabs() {
  const data = allData[currentDate];
  const container = document.getElementById('source-tabs');
  if (!data) { container.innerHTML = ''; return; }

  const totalCnt = data.total || 0;
  let html = `<button class="source-tab${currentSource==='all'?' active':''}"
    style="--color:#1a4fa0"
    onclick="selectSource('all')">ğŸ“Œ ì „ì²´ <span class="src-cnt">${totalCnt}</span></button>`;

  Object.entries(SOURCE_INFO).forEach(([src, info]) => {
    const srcData = data.sources?.[src];
    if (!srcData) return;
    const cnt = srcData.count || srcData.items?.length || 0;
    html += `<button class="source-tab${currentSource===src?' active':''}"
      style="--color:${info.color}"
      onclick="selectSource('${src}')">${info.icon} ${info.name} <span class="src-cnt">${cnt}</span></button>`;
  });

  container.innerHTML = html;
}

function selectSource(src) {
  currentSource = src;
  renderSourceTabs();
  applyFilters();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í•„í„°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFilters() {
  const catDiv = document.getElementById('cat-filters');
  catDiv.innerHTML = CATEGORIES.map(c =>
    `<button class="filter-chip${c===activeCategory?' active':''}" onclick="setCat('${c}')">${c}</button>`
  ).join('');

  const regDiv = document.getElementById('reg-filters');
  regDiv.innerHTML = REGIONS.map(r =>
    `<button class="filter-chip${r===activeRegion?' active':''}" onclick="setReg('${r}')">${r}</button>`
  ).join('');
}

function setCat(c) { activeCategory = c; renderFilters(); applyFilters(); }
function setReg(r) { activeRegion   = r; renderFilters(); applyFilters(); }
function setTargetFilter(t) {
  activeTarget = t;
  document.getElementById('f-all').classList.toggle('active', t==='all');
  document.getElementById('f-target').classList.toggle('active', t==='target');
  applyFilters();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// í•„í„° ì ìš© + ëª©ë¡ ë Œë”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getCurrentItems() {
  const data = allData[currentDate];
  if (!data) return [];

  let items = [];
  if (currentSource === 'all') {
    Object.values(data.sources || {}).forEach(s => { items = items.concat(s.items || []); });
  } else {
    items = data.sources?.[currentSource]?.items || [];
  }
  return items;
}

function applyFilters() {
  let items = getCurrentItems();

  if (activeCategory !== 'ì „ì²´') items = items.filter(i => i.category === activeCategory);
  if (activeRegion   !== 'ì „ì²´') items = items.filter(i => i.regionCategory === activeRegion);
  if (activeTarget === 'target')  items = items.filter(i => i.isTarget);

  // ì¶”ì²œ ë¨¼ì € ì •ë ¬
  items.sort((a, b) => (b.isTarget?1:0) - (a.isTarget?1:0));

  document.getElementById('list-stat-text').textContent =
    `ğŸ“‹ ${currentDate} Â· ${items.length}ê±´ í‘œì‹œ`;

  renderItemList(items);
}

function renderItemList(items) {
  const list = document.getElementById('item-list');
  if (items.length === 0) {
    list.innerHTML = `<div class="empty-msg"><p>ğŸ” í•´ë‹¹ ì¡°ê±´ì˜ ê³µê³ ê°€ ì—†ì–´ìš”</p><small>í•„í„°ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”</small></div>`;
    return;
  }

  // itemMapì— ë“±ë¡ (id â†’ item ê°ì²´)
  items.forEach(item => { itemMap[item.id] = item; });

  list.innerHTML = items.map(item => {
    const inCart = cart.some(c => c.id === item.id);
    const src = SOURCE_INFO[item.source] || {};
    // idë§Œ ë„˜ê²¨ì„œ HTML íŒŒì‹± ì˜¤ë¥˜ ë°©ì§€
    const safeId = item.id.replace(/'/g, "\\'");
    return `
    <div class="item-card${item.isTarget?' is-target':''}${inCart?' selected':''}"
         id="card-${item.id}" onclick="toggleCartById('${safeId}')">
      <input type="checkbox" ${inCart?'checked':''} onclick="event.stopPropagation();toggleCartById('${safeId}')">
      <div class="item-body">
        <div class="badge-row">
          ${item.isTarget ? '<span class="badge badge-target">â­ ì¶”ì²œ</span>' : ''}
          <span class="badge badge-cat">ğŸ“‚ ${item.category||'ì‚¬ì—…í™”'}</span>
          <span class="badge badge-region">ğŸ“ ${item.regionCategory||'ì „êµ­'}</span>
          ${currentSource==='all' ? `<span class="badge badge-source">${src.icon||''} ${src.name||item.source}</span>` : ''}
        </div>
        <div class="item-title">${item.cleanTitle||item.title}</div>
        <div class="item-meta">ğŸ“… ë§ˆê° ${item.date||'-'}</div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì¥ë°”êµ¬ë‹ˆ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// idë¡œ item ì¡°íšŒ í›„ í† ê¸€ (HTML ì¸ë¼ì¸ onclickì—ì„œ idë§Œ ì „ë‹¬)
function toggleCartById(id) {
  const item = itemMap[id];
  if (!item) return;
  toggleCart(item);
}

function toggleCart(item) {
  const idx = cart.findIndex(c => c.id === item.id);
  if (idx >= 0) {
    cart.splice(idx, 1);
  } else {
    if (cart.length >= 3) {
      alert('ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•´ìš”!');
      return;
    }
    cart.push(item);
  }
  updateCardState(item.id);
  renderCart();
}

function removeFromCart(id) {
  const idx = cart.findIndex(c => c.id === id);
  if (idx >= 0) cart.splice(idx, 1);
  updateCardState(id);
  renderCart();
}

function updateCardState(id) {
  const inCart = cart.some(c => c.id === id);
  const card = document.getElementById(`card-${id}`);
  const chk  = card?.querySelector('input[type=checkbox]');
  if (card) card.classList.toggle('selected', inCart);
  if (chk)  chk.checked = inCart;
}

function renderCart() {
  const body  = document.getElementById('cart-body');
  const count = document.getElementById('cart-count');
  const limit = document.getElementById('cart-limit');
  const btn   = document.getElementById('gen-btn');

  count.textContent = cart.length;
  limit.textContent = `${cart.length}/3ê°œ ì„ íƒë¨`;
  btn.classList.toggle('active', cart.length > 0);

  if (cart.length === 0) {
    body.innerHTML = `<div class="cart-empty"><div style="font-size:36px;">ğŸ“‹</div><p>ê³µê³ ë¥¼ ì„ íƒí•˜ë©´<br>ì—¬ê¸°ì— ë‹´ê²¨ìš”</p></div>`;
    return;
  }

  body.innerHTML = cart.map(item => {
    const src = SOURCE_INFO[item.source] || {};
    return `
    <div class="cart-item" id="cartitem-${item.id}">
      <button class="cart-remove" onclick="removeFromCart('${item.id}')">âœ•</button>
      <div class="cart-item-badges">
        ${item.isTarget ? '<span class="badge badge-target">â­</span>' : ''}
        <span class="badge badge-cat">ğŸ“‚ ${item.category||'ì‚¬ì—…í™”'}</span>
        <span class="badge badge-region">ğŸ“ ${item.regionCategory||'ì „êµ­'}</span>
      </div>
      <div class="cart-item-title">${item.cleanTitle||item.title}</div>
      <div class="cart-item-source">${src.icon||''} ${src.name||item.source} Â· ë§ˆê° ${item.date||'-'}</div>
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ì½˜í…ì¸  ìƒì„±
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startGenerate() {
  if (cart.length === 0) return;

  const urls = cart.map(i => i.url).join(',');
  const token = prompt('GitHub Personal Access Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”:\n(Settings â†’ Developer settings â†’ Personal access tokens â†’ Fine-grained tokens)');
  if (!token) return;

  showModal('â³', 'GitHub Actions ì‹¤í–‰ ì¤‘...', `${cart.length}ê±´ì˜ ê³µê³  ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ê³  ìˆì–´ìš”.\nì™„ë£Œë˜ë©´ ì´ë©”ì¼ë¡œ ë“œë¼ì´ë¸Œ ë§í¬ê°€ ì „ì†¡ë©ë‹ˆë‹¤.`);

  try {
    const res = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/actions/workflows/generate.yml/dispatches`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ ref: 'main', inputs: { target_urls: urls } })
    });

    if (res.ok || res.status === 204) {
      showModal('âœ…', 'ìƒì„± ìš”ì²­ ì™„ë£Œ!',
        `${cart.length}ê±´ì˜ ì½˜í…ì¸  ìƒì„±ì´ ì‹œì‘ëì–´ìš”.\n5~10ë¶„ í›„ ì´ë©”ì¼ë¡œ ë“œë¼ì´ë¸Œ ë§í¬ê°€ ì „ì†¡ë©ë‹ˆë‹¤.`, true);
    } else {
      const err = await res.json().catch(() => ({}));
      showModal('âŒ', 'ì˜¤ë¥˜ ë°œìƒ', `GitHub API ì˜¤ë¥˜: ${err.message||res.status}`, true);
    }
  } catch (e) {
    showModal('âŒ', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', e.message, true);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ëª¨ë‹¬
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showModal(icon, title, desc, showClose=false) {
  document.getElementById('modal-icon').textContent = icon;
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-desc').textContent = desc;
  document.getElementById('modal-close-btn').style.display = showClose ? 'inline-block' : 'none';
  document.getElementById('modal').classList.add('show');
}
function closeModal() { document.getElementById('modal').classList.remove('show'); }
</script>
</body>
</html>
