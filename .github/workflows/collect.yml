name: 공고 목록 수집 (매일 새벽)

on:
  schedule:
    # 매일 한국시간 새벽 2시 (UTC 17:00)
    - cron: '0 17 * * *'
  workflow_dispatch: # 수동 실행도 가능

jobs:
  collect:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설치
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Chrome 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser

      - name: 의존성 설치
        run: npm install

      - name: 공고 목록 수집
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          TO_EMAIL: nagairams1@gmail.com
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
        run: node collect.js

      - name: 파일 저장 (daily + today-list + collected_ids)
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add docs/today-list.json docs/daily/ collected_ids.json docs/detail-cache.json || true
          git diff --staged --quiet || git commit -m "공고 목록 업데이트 $(date +'%Y-%m-%d')"
          git push || true
