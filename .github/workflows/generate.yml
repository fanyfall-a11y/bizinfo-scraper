name: 콘텐츠 생성 (선택한 공고)

on:
  workflow_dispatch:
    inputs:
      target_urls:
        description: '생성할 공고 URL (쉼표로 구분, 최대 3개)'
        required: true
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 설치
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 한글 폰트 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk

      - name: Chrome 설치
        run: |
          sudo apt-get install -y chromium-browser

      - name: 의존성 설치
        run: npm install

      - name: 콘텐츠 생성
        env:
          TARGET_URLS: ${{ inputs.target_urls }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          TO_EMAIL: nagairams1@gmail.com
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/chromium-browser
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GOOGLE_OAUTH_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          GOOGLE_OAUTH_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
          GOOGLE_OAUTH_TOKENS: ${{ secrets.GOOGLE_OAUTH_TOKENS }}
        run: node generate.js

      - name: 수집 기록 저장
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add collected_ids.json || true
          git diff --staged --quiet || git commit -m "콘텐츠 생성 기록 업데이트 $(date +'%Y-%m-%d')"
          git push || true

      - name: 로그 확인
        if: always()
        run: cat auto_log.txt || echo "로그 없음"
